<!DOCTYPE html>
<html>
    <head>
    <title>Moor Walkers Map</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #0A4478;
            color: white;
            padding: 1em;
            text-align: center;
        }
        h1 {
            text-align: center;
            margin: 0;
            font-size: 2.5em;
        }
        p {
            font-size: 1.2em;
            margin-top: 2em;
            margin-bottom: 1em;
            text-align: center;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: center;
            font-size: 1.8em;
        }
        li {
            display: inline-block;
            margin: 0 1em;
        }
        a {
            display: block;
            padding: 0.5em 1em;
            background-color: #0A4478;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            font-size: 1.0em;
        }
        a:hover {
            background-color: #1A4E87;
        }
        /* Latest donation display */
        .latest-donation {
            background-color: #f0f8ff;
            border: 2px solid #0A4478;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            text-align: center;
        }
        .latest-donation h3 {
            color: #0A4478;
            margin-top: 0;
        }
        .latest-donation table {
            margin: 10px auto;
            border-collapse: collapse;
            background-color: white;
        }
        .latest-donation th {
            background-color: #0A4478;
            color: white;
            padding: 8px;
            font-size: 0.9em;
        }
        .latest-donation td {
            padding: 8px;
            border: 1px solid #ddd;
            font-size: 0.9em;
        }
        .latest-donation a {
            color: #0A4478;
            text-decoration: none;
            display: inline;
            padding: 0;
            background-color: transparent;
            border-radius: 0;
        }
        .latest-donation a:hover {
            text-decoration: underline;
            background-color: transparent;
        }
        .latest-donation a.button-link {
            display: inline-block;
            padding: 0.5em 1em;
            background-color: #0A4478;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        .latest-donation a.button-link:hover {
            background-color: #1A4E87;
            text-decoration: none;
        }
        .iframe-container {
            width: 100%;
            border: none;
            min-height: 2000px;
        }
    </style>
    <link rel="icon" href="https://moorwalkers.github.io/icons8-map-pastel-32.png" type="image/x-icon">
    </head>
    <body>
        <header>
            <h1>Moor Walkers Map</h1>
        </header>
        <main>
            <p>Welcome to our website, dedicated to showcasing the incredible walks that the Moor Walkers have taken over Dartmoor and the surrounding areas.
            <br>Join us on a journey through the heart of this stunning landscape and discover the hidden treasures that Dartmoor has to offer.
            <br><br>Each week we take a collection during our walks, and these collections are donated to charities proposed by our walkers.</p>
            
            <!-- Charity Information -->
            <div class="latest-donation">
                <h3>Latest Charity Collection</h3>
                <div id="donationLoading" style="font-style: italic; color: #666;">Loading...</div>
                <div id="donationContainer"></div>
                
                <h3 style="margin-top: 20px;">Next Proposed Charity</h3>
                <div id="upcomingLoading" style="font-style: italic; color: #666;">Loading...</div>
                <div id="upcomingContainer"></div>
                
                <p style="margin-top: 15px; text-align: center;">
                    <a href="charity_donations.html" class="button-link">View Recent Charity Collections & Donations</a>
                </p>
            </div>
            
            <p><strong>Click the links below to view the maps showing all tracks:</strong></p>
            <ul>
                <li><a href="https://moorwalkers.github.io/map_os.html">OS Map Layers<br>with All Tracks</a></li>
                <li><a href="https://moorwalkers.github.io/map_std.html">Standard Map Layers<br>with All Tracks</a></li>
            </ul>
            <br>
            <br>
            <p><strong>Or click one of the following Individual Map links to view individual tracks:</strong></p>

            <!-- iframe for tracks content -->
            <iframe src="tracks_content.html" class="iframe-container" id="tracksIframe"></iframe>
        </main>
    </body>
<script>
  // Auto-resize iframe based on content
  window.addEventListener('message', function(e) {
      if (e.data.type === 'resize') {
          document.getElementById('tracksIframe').style.height = e.data.height + 'px';
      }
  });
  
// Fetch and display latest charity donation
// IIFE (Immediately Invoked Function Expression) to keep variables scoped
(function() {
 // URL for the Google Sheets CSV export containing the charity donations and collections
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS9fPeRBDx4hLm3TU25ElZA14R2H5gSwoenN0ouGNmlfbyRRwqt2ODbQ0vVMZlVjA/pub?gid=1099060302&single=true&output=csv';

/**
 * Parses CSV text into a 2D array, handling quoted fields properly
 * @param {string} csv - Raw CSV text
 * @returns {Array} 2D array of parsed values
 */
function parseCSV(csv) {
    const result = [];
    let currentRow = [];
    let currentField = '';
    let insideQuotes = false;

    // Iterate through each character in the CSV string
    for (let i = 0; i < csv.length; i++) {
        const char = csv[i];
        const nextChar = csv[i + 1];

        if (char === '"') {
            // Handle escaped quotes (two consecutive quotes)
            if (insideQuotes && nextChar === '"') {
                currentField += '"';
                i++; // Skip the next quote
            } else {
                // Toggle quote state (entering or exiting quoted field)
                insideQuotes = !insideQuotes;
            }
        } else if (char === ',' && !insideQuotes) {
            // Comma outside quotes indicates field separator
            currentRow.push(currentField.trim());
            currentField = '';
        } else if (char === '\n' && !insideQuotes) {
            // Newline outside quotes indicates row separator
            currentRow.push(currentField.trim());
            
            // Only add non-empty rows
            if (currentRow.some(field => field !== '')) {
                result.push(currentRow);
            }
            currentRow = [];
            currentField = '';
        } else {
            // Handle newlines inside quotes (replace with space)
            if (char === '\n' && insideQuotes) {
                currentField += ' ';
            } else if (char === '\r') {
                // Skip carriage return characters
            } else {
                // Add regular characters to current field
                currentField += char;
            }
        }
    }

    // Handle the last field and row if present
    if (currentField || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(field => field !== '')) {
            result.push(currentRow);
        }
    }

    return result;
}

  function normalizeCellForPresenceCheck(cell) {
    // Handle null/undefined
    const s = (cell || '')
      // Remove common mojibake artefacts (Â, replacement char �)
      .replace(/[Â�]/g, '')
      // Collapse all whitespace (including non-breaking)
      .replace(/\u00A0/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    return s;
  }

  /**
   * Extracts the latest donation record from parsed CSV data
   * @param {Array} data - Parsed CSV data as 2D array
   * @returns {Object|null} Object containing headers and row data, or null if no valid data
   */
  function getLatestDonation(data) {
    // Return null if the data array is empty
    if (data.length === 0) return null;

    // Extract the header row (first row of the CSV)
    const headers = data[0];
    
    // Find the index of the "Amount Collected" column
    const amountCollectedIndex = headers.findIndex(h =>
      h.toLowerCase().includes('amount') && h.toLowerCase().includes('collected')
    );

    // If "Amount Collected" column doesn't exist, return null
    if (amountCollectedIndex === -1) return null;

    // Find the last row where Amount Collected has a non-blank value
    // This represents the most recent donation entry
    let lastValidRowIndex = -1;
    for (let i = 1; i < data.length; i++) {
      // Normalize the cell value to check if it has actual content
      const cellValue = normalizeCellForPresenceCheck(data[i][amountCollectedIndex]);
      if (cellValue !== '') {
        lastValidRowIndex = i;
      }
    }
    
    // If no valid rows found, return null
    if (lastValidRowIndex === -1) return null;

    // Build a list of column indices to keep (exclude unwanted columns)
    const columnsToKeep = [];
    for (let colIndex = 0; colIndex < headers.length; colIndex++) {
      const header = headers[colIndex];
      const headerLower = header.toLowerCase();

      // Skip columns that should be excluded from display
      // These include: Charity No/Name, Gift Aid, Notes, Weekly/Monthly averages, Month, Week
      if ((headerLower.includes('charity') && headerLower.includes('no') && headerLower.includes('name')) ||
          (headerLower.includes('gift') && headerLower.includes('aid')) ||
          headerLower.includes('notes') ||
          (headerLower.includes('average') && headerLower.includes('weekly')) ||
          headerLower.includes('month') ||
          headerLower.includes('week') ||
          (headerLower.includes('average') && headerLower.includes('monthly'))) {
        continue;
      }

      // Check if this is a "Total Collected YYYY/YY" column
      // These columns show cumulative totals for specific years
      const isTotalCollectedColumn =
        headerLower.includes('total') &&
        headerLower.includes('collected') &&
        /\d{4}\/\d{2}/.test(header);

      if (isTotalCollectedColumn) {
        // Only keep this total column if it has a value in the latest row
        const raw = data[lastValidRowIndex][colIndex] || '';
        const present = normalizeCellForPresenceCheck(raw) !== '';
        if (present) {
          columnsToKeep.push(colIndex);
        }
      } else {
        // Keep all other non-excluded columns
        columnsToKeep.push(colIndex);
      }
    }

    // Return an object with filtered headers and the corresponding row data
    return {
      headers: columnsToKeep.map(idx => headers[idx]),
      row: columnsToKeep.map(idx => data[lastValidRowIndex][idx])
    };
  }

  /**
   * Displays the donation data as an HTML table
   * @param {Object|null} donation - Object containing headers and row arrays
   */
  function displayDonation(donation) {
    // Get the loading indicator element
    const loadingEl = document.getElementById('donationLoading');
    
    // If no donation data available, hide loading and show message
    if (!donation) {
      if (loadingEl) loadingEl.style.display = 'none';
      document.getElementById('donationContainer').innerHTML = '<p>No donation data available</p>';
      return;
    }

    // Find the column index for "Donation Recipient" to apply special link formatting
    const donationRecipientIndex = donation.headers.findIndex(h =>
      h.toLowerCase().includes('donation') && h.toLowerCase().includes('recipient')
    );

    // Build the HTML table - start with table header row
    let html = '<table><tr>';
    donation.headers.forEach(header => {
      html += `<th>${header}</th>`;
    });
    html += '</tr><tr>';

    // Build the data row
    donation.row.forEach((cell, idx) => {
      let cellContent = cell;
      
      // If this is the Donation Recipient column and contains a URL, make it clickable
      if (idx === donationRecipientIndex && cell && String(cell).match(/^https?:\/\//)) {
        cellContent = `<a href="${cell}" target="_blank" rel="noopener noreferrer">${cell}</a>`;
      }
      
      // Add the cell to the table (use nullish coalescing to handle null/undefined)
      html += `<td>${cellContent ?? ''}</td>`;
    });
    html += '</tr></table>';

    // Hide the loading indicator and display the table
    if (loadingEl) loadingEl.style.display = 'none';
    document.getElementById('donationContainer').innerHTML = html;
  }

  // Fetch the CSV data from Google Sheets and display the latest donation
  fetch(csvUrl)
    .then(response => response.text())
    .then(csv => {
      // Parse the CSV text into a 2D array
      const data = parseCSV(csv);
      
      // Extract the latest donation record
      const latestDonation = getLatestDonation(data);
      
      // Hide the loading indicator
      const loadingEl = document.getElementById('donationLoading');
      if (loadingEl) loadingEl.style.display = 'none';
      
      // Display the donation data
      displayDonation(latestDonation);
    })
    .catch(error => {
      // If fetch fails, hide loading and show error message
      const loadingEl = document.getElementById('donationLoading');
      if (loadingEl) loadingEl.style.display = 'none';
      document.getElementById('donationContainer').innerHTML =
        `<p style="color: red;">Error loading donation data</p>`;
    });
})();
  
  // Fetch and display Next proposed charity
  // IIFE (Immediately Invoked Function Expression) to keep variables scoped
  (function() {
      // URL for the Google Sheets CSV export containing upcoming charity proposals
      const csvUrl2 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS9fPeRBDx4hLm3TU25ElZA14R2H5gSwoenN0ouGNmlfbyRRwqt2ODbQ0vVMZlVjA/pub?gid=150385441&single=true&output=csv';
      
      /**
       * Parses CSV text into a 2D array, handling quoted fields properly
       * @param {string} csv - Raw CSV text
       * @returns {Array} 2D array of parsed values
       */
      function parseCSV(csv) {
          const result = [];
          let currentRow = [];
          let currentField = '';
          let insideQuotes = false;
          
          // Iterate through each character in the CSV string
          for (let i = 0; i < csv.length; i++) {
              const char = csv[i];
              const nextChar = csv[i + 1];
              
              if (char === '"') {
                  // Handle escaped quotes (two consecutive quotes)
                  if (insideQuotes && nextChar === '"') {
                      currentField += '"';
                      i++; // Skip the next quote
                  } else {
                      // Toggle quote state (entering or exiting quoted field)
                      insideQuotes = !insideQuotes;
                  }
              } else if (char === ',' && !insideQuotes) {
                  // Comma outside quotes indicates field separator
                  currentRow.push(currentField.trim());
                  currentField = '';
              } else if (char === '\n' && !insideQuotes) {
                  // Newline outside quotes indicates row separator
                  currentRow.push(currentField.trim());
                  
                  // Only add non-empty rows
                  if (currentRow.some(field => field !== '')) {
                      result.push(currentRow);
                  }
                  currentRow = [];
                  currentField = '';
              } else {
                  // Handle newlines inside quotes (replace with space)
                  if (char === '\n' && insideQuotes) {
                      currentField += ' ';
                  } else if (char === '\r') {
                      // Skip carriage return characters
                  } else {
                      // Add regular characters to current field
                      currentField += char;
                  }
              }
          }
          
          // Handle the last field and row if present
          if (currentField || currentRow.length > 0) {
              currentRow.push(currentField.trim());
              if (currentRow.some(field => field !== '')) {
                  result.push(currentRow);
              }
          }
          
          return result;
      }
      
      /**
       * Extracts the first upcoming charity from parsed CSV data
       * @param {Array} data - Parsed CSV data as 2D array
       * @returns {Object|null} Object containing headers and row data, or null if no valid data
       */
      function getFirstUpcoming(data) {
          // Return null if insufficient data
          if (data.length === 0 || data.length < 2) return null;
          
          // Extract the header row
          const headers = data[0];
          
          // Find the first row with any content (skip header row)
          let firstValidRowIndex = -1;
          for (let i = 1; i < data.length; i++) {
              const hasContent = data[i].some(cell => cell && cell.trim() !== '');
              if (hasContent) {
                  firstValidRowIndex = i;
                  break;
              }
          }
          
          // If no valid rows found, return null
          if (firstValidRowIndex === -1) return null;
          
          // Build list of columns to keep, excluding "Registered Charity" column
          const columnsToKeep = [];
          for (let colIndex = 0; colIndex < headers.length; colIndex++) {
              const header = headers[colIndex];
              const headerLower = header.toLowerCase();
              
              // Skip "Registered Charity" column (contains registration numbers)
              if (headerLower.includes('registered') && headerLower.includes('charity')) {
                  continue;
              }
              
              columnsToKeep.push(colIndex);
          }
          
          // Return an object with filtered headers and the corresponding row data
          return {
              headers: columnsToKeep.map(idx => headers[idx]),
              row: columnsToKeep.map(idx => data[firstValidRowIndex][idx])
          };
      }
      
      /**
       * Displays the upcoming charity data as an HTML table
       * @param {Object|null} upcoming - Object containing headers and row arrays
       */
      function displayUpcoming(upcoming) {
          // If no data available, show message
          if (!upcoming) {
              document.getElementById('upcomingContainer').innerHTML = '<p>No next proposed charity data available</p>';
              return;
          }
          
          // Find the column index for "Charity URL" to apply link formatting
          const charityUrlIndex = upcoming.headers.findIndex(h => 
              h.toLowerCase().includes('charity') && h.toLowerCase().includes('url')
          );
          
          // Build the HTML table - start with header row
          let html = '<table><tr>';
          upcoming.headers.forEach(header => {
              html += `<th>${header}</th>`;
          });
          html += '</tr><tr>';
          
          // Build the data row
          upcoming.row.forEach((cell, idx) => {
              let cellContent = cell;
              
              // If this is the Charity URL column and contains a URL, make it clickable
              if (idx === charityUrlIndex && cell && cell.match(/^https?:\/\//)) {
                  cellContent = `<a href="${cell}" target="_blank">${cell}</a>`;
              }
              
              // Add the cell to the table
              html += `<td>${cellContent}</td>`;
          });
          html += '</tr></table>';
          
          // Display the table in the container
          document.getElementById('upcomingContainer').innerHTML = html;
      }
      
      // Fetch the CSV data from Google Sheets and display the upcoming charity
      fetch(csvUrl2)
          .then(response => response.text())
          .then(csv => {
              // Parse the CSV text into a 2D array
              const data = parseCSV(csv);
              
              // Extract the first upcoming charity record
              const upcomingCharity = getFirstUpcoming(data);
              
              // Hide the loading indicator
              document.getElementById('upcomingLoading').style.display = 'none';
              
              // Display the upcoming charity data
              displayUpcoming(upcomingCharity);
          })
          .catch(error => {
              // If fetch fails, hide loading and show error message
              document.getElementById('upcomingLoading').style.display = 'none';
              document.getElementById('upcomingContainer').innerHTML = `<p style="color: red;">Error loading next proposed charity data</p>`;
          });
  })();
</script>
</html>
    